from typing import Dict, Any, List
import json
import time

class InformationHandler:
    """
    Classe respons√°vel por gerenciar solicita√ß√µes de informa√ß√µes,
    incluindo indicadores do Fhemig em N√∫meros e outros relat√≥rios do SIGH e Tasy.
    """

    def __init__(self, indicators_file: str, fhemig_numeros_file: str, sigh_reports_file: str, tasy_reports_file: str):
        """
        Inicializa o InformationHandler.

        :param indicators_file: Caminho para o arquivo JSON contendo os indicadores.
        :param sigh_reports_file: Caminho para o arquivo JSON contendo informa√ß√µes indicadores Fhemig do Futuro.
        :param sigh_reports_file: Caminho para o arquivo JSON contendo informa√ß√µes sobre relat√≥rios do SIGH.
        :param tasy_reports_file: Caminho para o arquivo JSON contendo informa√ß√µes sobre relat√≥rios do Tasy.
        """
        self.indicators_fhemig_futuro = self.load_data(indicators_file)
        self.indicators_fhemig_numeros = self.load_data(fhemig_numeros_file)
        self.sigh_reports = self.load_data(sigh_reports_file)
        self.tasy_reports = self.load_data(tasy_reports_file)
        self.fhemig_em_numeros_indicators = {
            "1": "Taxa de Ocupa√ß√£o Hospitalar",
            "2": "Tempo M√©dio de Perman√™ncia",
            "3": "N√∫mero de Interna√ß√µes",
            "4": "N√∫mero de Cirurgias",
            "5": "N√∫mero de Doadores Efetivos",
            "6": "Outros"
        }


    def load_data(self, file_path: str) -> Dict[str, Any]:
        """
        Carrega dados a partir de um arquivo JSON.

        :param file_path: Caminho para o arquivo JSON.
        :return: Dicion√°rio contendo os dados carregados.
        """
        try:
            with open(file_path, 'r', encoding='utf-8') as file:
                return json.load(file)
        except FileNotFoundError:
            print(f"Erro: Arquivo n√£o encontrado: {file_path}")
            return {}
        except json.JSONDecodeError:
            print(f"Erro: Falha ao decodificar o arquivo JSON: {file_path}")
            return {}

    def handle_indicator_fhemig_futuro(self, indicator_choice: str, unit: str) -> Dict[str, Any]:
        """
        Processa a solicita√ß√£o de um indicador espec√≠fico do Painel Fhemig do Futuro.

        :param indicator_choice: Escolha do indicador pelo usu√°rio.
        :param unit: Unidade selecionada pelo usu√°rio.
        :return: Dicion√°rio contendo a resposta formatada em Markdown.
        """

        ## √çndice e nome dos indicadores FF
        indicator_map = {str(i): indicator['nome'] for i, indicator in enumerate(self.indicators_fhemig_futuro.values(), 1)}
        
        
        indicator_name = indicator_map[indicator_choice]
        painel_url = "https://app.powerbi.com/view?r=eyJrIjoiZmY0NmIxZmYtMDdkMy00Yzg1LTkxY2ItZjBhOWEwMTJlNDVhIiwidCI6IjM4ZjAxMzYyLTRiMWMtNGU2ZS05MDE0LTAzN2M1ZDA0MTMyNyJ9"
            
        message = (
                f"""Entendi! üìä Vamos acessar o indicador **{indicator_name}** para a unidade **{unit}**.

                O **Painel Fhemig do Futuro** √© uma ferramenta essencial para monitorar o desempenho e a qualidade dos servi√ßos em nossa institui√ß√£o. 

                Siga estas etapas simples para visualizar o indicador:

                1Ô∏è‚É£ Acesse o **[Painel Fhemig do Futuro]({painel_url})**
                2Ô∏è‚É£ No menu lateral, selecione sua unidade: {unit}
                3Ô∏è‚É£ Localize o indicador '{indicator_name}' no painel

                Se encontrar qualquer dificuldade, n√£o hesite em contatar nosso N√∫cleo de Informa√ß√£o:
                üìß nucleo.informacao@fhemig.mg.gov.br

                Lembre-se, explorar diferentes indicadores pode oferecer insights valiosos sobre o desempenho da sua unidade!

                O que voc√™ gostaria de fazer agora?

                1Ô∏è‚É£ Solicitar informa√ß√µes sobre outro indicador
                2Ô∏è‚É£ Entrar em contato diretamente com o N√∫cleo de Informa√ß√£o
                3Ô∏è‚É£ Encerrar nossa conversa

                Por favor, digite o n√∫mero da sua escolha (1-3)."""               
                )
            
        return {
                "success": True,
                "message": message,
                "next_state": "feedback"
                }
    
    def handle_fhemig_em_numeros(self, indicator: str, unit: str) -> Dict[str, Any]:
            """
            Fornece informa√ß√µes sobre como acessar o indicador espec√≠fico no Fhemig em N√∫meros.

            :param indicator: Nome do indicador selecionado.
            :param unit: Nome da unidade.
            :return: Dicion√°rio com a resposta formatada.
            """
            
            indicator_map = {str(i): indicator['nome'] for i, indicator in enumerate(self.indicators_fhemig_numeros.values(), 1)}
            url_fhemig_numeros = "https://pentaho.fhemig.mg.gov.br:8080"

            
            indicator_name = indicator_map[indicator]
            message = (f"""Entendi! üìä Vamos acessar o indicador **{indicator_name}** para a unidade **{unit}** usando o Fhemig em N√∫meros.

                        Esta ferramenta poderosa permite uma an√°lise detalhada dos dados. Siga estas instru√ß√µes passo a passo para obter as informa√ß√µes que voc√™ precisa:

                        üîπ Acesso e Configura√ß√£o Inicial:
                        1. Acesse o **[Fhemig em N√∫meros]({url_fhemig_numeros})**
                        2. Clique em 'Create a new query'
                        3. Selecione o cubo 'Atendimentos'
                        4. Selecione o indicador '{indicator_name}'

                        üîπ Configura√ß√£o de Datas:
                        5. Clique no campo 'Datas'
                        6. Arraste o campo 'M√™s' para o espa√ßo 'Colunas' na tela principal
                        7. Arraste tamb√©m o campo 'Ano'
                        8. Na √°rea 'Colunas', clique duas vezes em 'Ano'
                        9. Escolha os anos desejados
                        10. Clique em '>'
                        11. Clique em 'OK'

                        üîπ Sele√ß√£o da Unidade:
                        12. No canto inferior esquerdo, clique na setinha do campo 'Hospitais'
                        13. Arraste o campo 'Hospitais' para a √°rea 'Linhas'
                        14. Clique duas vezes em 'Hospital' para abrir o filtro
                        15. Selecione '{unit}'
                        16. Clique em '>'
                        17. Finalize clicando em 'OK'

                        üí° Dica: Para uma visualiza√ß√£o mais clara, voc√™ pode ajustar a ordem das colunas e linhas conforme sua prefer√™ncia.

                        üìπ Tutorial Visual:
                        Para uma demonstra√ß√£o pr√°tica, confira o v√≠deo tutorial abaixo. Ele mostra como obter o indicador 'Taxa de Ocupa√ß√£o Hospitalar' como exemplo, mas o processo √© similar para outros indicadores.

                        [Inserir link do v√≠deo aqui]

                        Precisa de mais alguma orienta√ß√£o ou gostaria de explorar outro indicador? Estou aqui para ajudar! üòä

                        1Ô∏è‚É£ Solicitar informa√ß√µes sobre outro indicador
                        2Ô∏è‚É£ Tirar d√∫vidas sobre o Fhemig em N√∫meros
                        3Ô∏è‚É£ Encerrar nossa conversa

                        Por favor, digite o n√∫mero da sua escolha (1-3)."""
                                )       
            
            return {
                "success": True,
                "message": message,
                "next_state": "feedback"
                    }

    def handle_pentaho(self, unit: str, system: str) -> Dict[str, Any]:
        """
        Processa encaminhamento de indicadores dentro do SIGH mas que n√£o est√£o no Fhemig em N√∫meros

        :param info_request: Descri√ß√£o da informa√ß√£o solicitada pelo usu√°rio.
        :param unit: Unidade selecionada pelo usu√°rio.
        :param system: Sistema utilizado pela unidade (SIGH ou Tasy).
        :return: Dicion√°rio contendo a resposta formatada.
        """

        url_pentaho = "url"
        ## IDEIA - funcionalidade para solicitar automaticamente o acesso ao Pentaho
        message = (f"""üè• Informa√ß√µes Detalhadas sobre {unit} üìä

                    Para acessar um conjunto abrangente de relat√≥rios e dados sobre a **{unit}**, utilize nossa ferramenta de gerenciamento de relat√≥rios, o **Pentaho**.

                    üîê Acesso ao Pentaho:

                    J√° possui login e senha?
                    1. Visite o [Pentaho]({url_pentaho})
                    2. Clique em 'Login'
                    3. Digite seu login e senha
                    4. Clique em 'Entrar'

                    üÜï Precisa de acesso?

                    Se voc√™ ainda n√£o tem acesso ao Pentaho, siga estas etapas:

                    1. Envie um e-mail para: nucleo.informacao@fhemig.mg.gov.br
                    2. Assunto: "Solicita√ß√£o de Acesso ao Pentaho"
                    3. No corpo do e-mail, inclua:
                    ‚Ä¢ Nome completo
                    ‚Ä¢ Unidade: {unit}
                    ‚Ä¢ Setor em que trabalha

                    Nossa equipe do N√∫cleo de Informa√ß√£o processar√° sua solicita√ß√£o o mais r√°pido poss√≠vel.

                    üí° Dica: O Pentaho oferece uma variedade de relat√≥rios personaliz√°veis. 

                    Precisa de mais alguma orienta√ß√£o?

                    1Ô∏è‚É£ Saiba mais sobre os tipos de relat√≥rios dispon√≠veis no Pentaho
                    2Ô∏è‚É£ Solicitar ajuda com outra ferramenta ou indicador
                    3Ô∏è‚É£ Encerrar nossa conversa

                    Digite o n√∫mero da sua escolha (1-3)."""
                   
                   )


        return {
                "success": True,
                "message": message,
                "next_state": "feedback"
            }

    def handle_tasy(self, unit: str, system: str) -> Dict[str, Any]:
        """
        Processa encaminhamento de indicadores dentro do SIGH mas que n√£o est√£o no Fhemig em N√∫meros

        :param info_request: Descri√ß√£o da informa√ß√£o solicitada pelo usu√°rio.
        :param unit: Unidade selecionada pelo usu√°rio.
        :param system: Sistema utilizado pela unidade (SIGH ou Tasy).
        :return: Dicion√°rio contendo a resposta formatada.
        """

        message = (f"""üìä Acessando Relat√≥rios do Tasy para {unit} üè•

                    Voc√™ pode obter informa√ß√µes detalhadas sobre a **{unit}** atrav√©s do m√≥dulo de relat√≥rios do sistema {system}. Siga este guia passo a passo para acessar os relat√≥rios do Tasy:

                    üîç Localizando os Relat√≥rios:
                    1. Na tela inicial do Tasy, clique na aba 'Utilit√°rios'
                    2. Selecione 'Impress√£o de Relat√≥rios'
                    3. Na nova janela, digite **FHEMIG - NI** no campo 't√≠tulo'
                    4. Clique em 'Filtrar'

                    üìÑ Selecionando e Exportando o Relat√≥rio:
                    5. Na janela √† direita, d√™ um duplo clique no relat√≥rio desejado
                    6. Preencha os campos solicitados
                    7. Clique em 'Exportar XLS'
                    8. Na pr√≥xima tela, clique em 'Continuar'

                    üíæ Baixando o Relat√≥rio:
                    9. O download iniciar√° no canto superior direito
                    10. Clique em 'Manter' ap√≥s o in√≠cio do download
                    11. O arquivo ser√° salvo na pasta de downloads do seu computador

                    ‚ö†Ô∏è Observa√ß√µes Importantes:
                    ‚Ä¢ Use apenas relat√≥rios com t√≠tulo 'FHEMIG - NI' (validados pelo N√∫cleo de Informa√ß√£o)
                    ‚Ä¢ Verifique a estrutura e os dados do relat√≥rio baixado
                    ‚Ä¢ Informe no hist√≥rico da ordem de servi√ßo se s√£o necess√°rios ajustes ou se o relat√≥rio est√° aprovado

                    ‚ùì N√£o encontrou o relat√≥rio necess√°rio?
                    Entre em contato com a refer√™ncia de informa√ß√£o da sua unidade para solicitar a cria√ß√£o de um novo relat√≥rio.

                    üí° Dica: Familiarize-se com os relat√≥rios dispon√≠veis. Isso pode ajudar a identificar oportunidades de melhoria e tomada de decis√µes baseadas em dados!

                    Precisa de mais alguma orienta√ß√£o?

                    1Ô∏è‚É£ Tirar d√∫vidas sobre os relat√≥rios do Tasy
                    2Ô∏è‚É£ Solicitar informa√ß√µes sobre outro sistema ou indicador
                    3Ô∏è‚É£ Encerrar nossa conversa

                    Digite o n√∫mero da sua escolha (1-3).""")

        
        return {
                "success": True,
                "message": message,
                "next_state": "feedback"
            }



    def handle_feedback(self) -> Dict[str, Any]:
        message = (f"""Claro! üì¨ Estou pronto para ajudar voc√™ a entrar em contato com o N√∫cleo de Informa√ß√£o.

                    Por favor, digite sua mensagem abaixo. Procure incluir:

                    ‚Ä¢ Uma descri√ß√£o clara da sua solicita√ß√£o ou d√∫vida
                    ‚Ä¢ Detalhes relevantes (por exemplo, unidade, sistema ou indicador espec√≠fico)
                    ‚Ä¢ Qualquer prazo ou urg√™ncia, se aplic√°vel

                    Sua mensagem ser√° encaminhada diretamente ao N√∫cleo de Informa√ß√£o. Eles analisar√£o sua solicita√ß√£o e entrar√£o em contato o mais breve poss√≠vel.

                    üí° Dica: Quanto mais detalhada for sua mensagem, mais r√°pido e eficiente ser√° o atendimento!

                    Assim que terminar de digitar sua mensagem, envie-a e eu confirmarei o encaminhamento.

                    Pronto para come√ßar? Digite sua mensagem agora:""")
        
        return {
                "success": True,
                "message": message,
                "next_state": "feedback"
            }