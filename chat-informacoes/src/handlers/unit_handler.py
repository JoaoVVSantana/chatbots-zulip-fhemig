from typing import Dict, List, Any
import json

class UnitHandler:
    """
    Classe respons√°vel por gerenciar a sele√ß√£o de unidades da Fhemig.
    """

    def __init__(self, units_file: str):
        """
        Inicializa o UnitHandler.

        :param units_file: Caminho para o arquivo JSON contendo as informa√ß√µes das unidades.
        """
        self.units = self.load_units(units_file)
        self.unit_names = [unit['name'] for unit in self.units]

    def load_units(self, file_path: str) -> List[Dict[str, Any]]:
        """
        Carrega as unidades a partir de um arquivo JSON.

        :param file_path: Caminho para o arquivo JSON das unidades.
        :return: Lista de dicion√°rios contendo informa√ß√µes das unidades.
        """
        try:
            with open(file_path, 'r', encoding='utf-8') as file:
                return json.load(file)
        except FileNotFoundError:
            print(f"Erro: Arquivo de unidades n√£o encontrado: {file_path}")
            return []
        except json.JSONDecodeError:
            print(f"Erro: Falha ao decodificar o arquivo JSON: {file_path}")
            return []

    def get_initial_message(self, nome_usuario) -> str:
        """
        Retorna a mensagem inicial para sele√ß√£o de unidade.

        :return: String contendo a mensagem de boas-vindas e a lista de unidades.
        """
        unit_list = "\n".join([f"{i+1}. {unit['name']}" for i, unit in enumerate(self.units)])
        return (
            f"""Ol√°, {nome_usuario}! üëã Bem-vindo(a) ao Assistente Virtual da Fhemig!

            Estou aqui para facilitar seu acesso √†s informa√ß√µes cruciais para seu dia a dia
            de trabalho. 
            Vamos come√ßar nossa jornada selecionando a sua unidade de trabalho.

            Por favor, escolha o n√∫mero correspondente √† sua unidade na lista abaixo:

            {unit_list}

            Ap√≥s a sele√ß√£o, poderei te ajudar com:
            ‚Ä¢ Consulta de indicadores espec√≠ficos da sua unidade
            ‚Ä¢ Acesso a relat√≥rios e informa√ß√µes do sistema de gest√£o hospitalar
            ‚Ä¢ Esclarecimento de d√∫vidas sobre os dados dispon√≠veis

            Estou animado para auxiliar voc√™! Vamos l√°, qual √© o n√∫mero da sua unidade? üòä"""
        )

    def handle(self, user_input: str) -> Dict[str, Any]:
        """
        Processa a entrada do usu√°rio para sele√ß√£o de unidade.

        :param user_input: Entrada do usu√°rio (n√∫mero da unidade).
        :return: Dicion√°rio contendo o resultado do processamento.
        """
        if user_input.isdigit():
            index = int(user_input) - 1
            print(f"User input: {user_input}, Calculated index: {index}")
            if 0 <= index < len(self.units):
                selected_unit = self.units[index]
                print(f"Selected unit: {selected_unit}")
                return self.create_success_response(selected_unit)
        
        return self.create_error_response("Por favor, digite apenas o n√∫mero da unidade desejada.")

    def create_success_response(self, unit: Dict[str, str]) -> Dict[str, Any]:
        """
        Cria uma resposta de sucesso para a sele√ß√£o de unidade.

        :param unit: Dicion√°rio contendo informa√ß√µes da unidade selecionada.
        :return: Dicion√°rio com a resposta formatada de sucesso.
        """
        return {
            "success": True,
            "selected_unit": unit['name'],
            "system": unit['system'],
            "message": (

                f"""Obrigado!
                
                Voc√™ selecionou a unidade {unit['name']}, que utiliza o sistema {unit['system']}.

                Agora, vamos acessar as informa√ß√µes mais relevantes para voc√™.

                Por favor, selecione o n√∫mero correspondente ao indicador que voc√™ deseja consultar:

                1Ô∏è‚É£ Taxa de Ocupa√ß√£o Hospitalar
                2Ô∏è‚É£ Tempo M√©dio de Perman√™ncia
                3Ô∏è‚É£ N√∫mero de Interna√ß√µes
                4Ô∏è‚É£ N√∫mero de Cirurgias
                5Ô∏è‚É£ N√∫mero de Doadores Efetivos
                6Ô∏è‚É£ Outros

                Digite apenas o n√∫mero da sua escolha (1-6).

                Ap√≥s sua sele√ß√£o, lhe informarei como acessar essa informa√ß√£o nas fontes oficiais da Fhemig. 
                
                Se voc√™ precisar de informa√ß√µes n√£o listadas aqui, a 
                op√ß√£o "Outros" est√° dispon√≠vel para atender √†s suas necessidades espec√≠ficas.

                Estou aqui para ajudar! Qual informa√ß√£o voc√™ precisa? üìä"""

            )
        }

    def create_error_response(self, error_message: str) -> Dict[str, Any]:
        """
        Cria uma resposta de erro para sele√ß√£o inv√°lida de unidade.

        :param error_message: Mensagem de erro a ser exibida.
        :return: Dicion√°rio com a resposta formatada de erro.
        """
        return {
            "success": False,
            "message": f"{error_message}"
        }
